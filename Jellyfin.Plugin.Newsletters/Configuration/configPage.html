<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Newsletters</title>
</head>

<body>
    <div id="NewsletterConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="NewsletterConfigForm">
                    <!-- Tab Navigation -->
                    <div class="tab-bar">
                        <button type="button" class="tab-link active"
                            onclick="openTab(event, 'General')">General</button>
                        <button type="button" class="tab-link" onclick="openTab(event, 'Email')">Email</button>
                        <button type="button" class="tab-link" onclick="openTab(event, 'Discord')">Discord</button>
                        <button type="button" class="tab-link" onclick="openTab(event, 'Telegram')">Telegram</button>
                    </div>

                    <!-- General Tab -->
                    <div id="General" class="tab-content" style="display: block;">
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="DebugMode" name="DebugMode" type="checkbox" is="emby-checkbox" />
                                <span>Debug Mode</span>
                            </label>
                        </div>
                        <div id="CommonDetails">
                            <div class="inputContainer" id="LocalHostname">
                                <label class="inputLabel inputLabelUnfocused" for="Hostname">Server URL:</label>
                                <input id="Hostname" name="Hostname" type="text" is="emby-input" />
                                <div class="fieldDescription">
                                    Hostname for your JF server that is accessible from outside your network. Ensure to
                                    include http[s]:// and port number (if applicable). <b>DO NOT include a trailing
                                        slash '/'</b>.
                                    <br>
                                    i.e: https://myServerDNSName.com:8096
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="SeriesEnabled" value="false" />
                        <input type="hidden" id="MoviesEnabled" value="false" />

                        <div class="inputContainer" id="LibrarySelection">
                            <label class="inputLabel inputLabelUnfocused">Library Selection:</label>
                            <table class="library-table">
                                <thead>
                                    <tr>
                                        <th>Series</th>
                                        <th>Movies</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div style="margin-bottom: 10px;">
                                                <button id="SelectAllSeries" is="emby-button" type="button"
                                                    class="raised button-submit select-all-btn"
                                                    onclick="toggleAll('Series')">
                                                    <span>Select All Series</span>
                                                </button>
                                            </div>
                                            <div id="SeriesLibraryCheckboxes" class="library-checkbox-container">
                                                <p class="loading-text">Loading series libraries...</p>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="margin-bottom: 10px;">
                                                <button id="SelectAllMovies" is="emby-button" type="button"
                                                    class="raised button-submit select-all-btn"
                                                    onclick="toggleAll('Movies')">
                                                    <span>Select All Movies</span>
                                                </button>
                                            </div>
                                            <div id="MoviesLibraryCheckboxes" class="library-checkbox-container">
                                                <p class="loading-text">Loading movies libraries...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="inputContainer" id="NewsletterEventSettings">
                            <label class="inputLabel inputLabelUnfocused">Newsletter Event Settings:</label>
                            <table>
                                <tr>
                                    <td style="vertical-align: top;">
                                        <div class="checkboxContainer checkboxContainer-withDescription">
                                            <label class="emby-checkbox-label">
                                                <input id="NewsletterOnItemAddedEnabled"
                                                    name="NewsletterOnItemAddedEnabled" type="checkbox"
                                                    is="emby-checkbox" />
                                                <span>Send newsletter when items are added</span>
                                            </label>
                                        </div>
                                    </td>
                                    <td style="vertical-align: top;">
                                        <div class="checkboxContainer checkboxContainer-withDescription">
                                            <label class="emby-checkbox-label">
                                                <input id="NewsletterOnItemDeletedEnabled"
                                                    name="NewsletterOnItemDeletedEnabled" type="checkbox"
                                                    is="emby-checkbox" />
                                                <span>Send newsletter when items are deleted</span>
                                            </label>
                                        </div>
                                    </td>
                                    <td style="vertical-align: top;">
                                        <div class="checkboxContainer checkboxContainer-withDescription">
                                            <label class="emby-checkbox-label">
                                                <input id="NewsletterOnItemUpdatedEnabled"
                                                    name="NewsletterOnItemUpdatedEnabled" type="checkbox"
                                                    is="emby-checkbox" />
                                                <span>Send newsletter when items are updated</span>
                                            </label>
                                            <details style="margin-top: 5px; font-size: 0.85rem; cursor: pointer;">
                                                <summary style="opacity: 0.7;">How does detection work?</summary>
                                                <p
                                                    style="padding: 10px; background: rgba(0,0,0,0.15); border-radius: 4px; margin-top: 5px; line-height: 1.4;">
                                                    Enable this to receive newsletters when items are updated. The
                                                    update detection works differently than Jellyfin's built-in update
                                                    event. This plugin detects updates based on how Radarr/Sonarr handle
                                                    media upgrades - when a file is upgraded, the old file is deleted
                                                    and a new one is added. This means an update is detected when a file
                                                    deletion is immediately followed by a file addition with the same
                                                    title/season/episode information.
                                                </p>
                                            </details>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="inputContainer" id="CommunityRatingDecimals">
                            <label class="inputLabel inputLabelUnfocused" for="CommunityRatingDecimalPlaces">Community
                                Rating Decimal Places:</label>
                            <input id="CommunityRatingDecimalPlaces" name="CommunityRatingDecimalPlaces" type="number"
                                is="emby-input" min="0" max="4" />
                            <div class="fieldDescription">
                                Number of decimal places to display for community ratings (0-4). Default: 1
                            </div>
                        </div>
                        <div class="selectContainer">
                            <label class="selectLabel" for="HostingSelector">Poster Type:</label>
                            <select is="emby-select" id="HostingSelector" name="HostingSelector"
                                class="emby-select-withcolor emby-select">
                                <option id="defaultTmdb" value="tmdb">TMDB Poster (Default)</option>
                                <option id="localJFHosting" value="attachment">Local Poster Images</option>
                            </select>
                        </div>
                        <hr>
                        <div id="MaxEmailSizeContainer" name="options" style="display: none;">
                            <div class="inputContainer" id="MaxEmailSize">
                                <label class="inputLabel inputLabelUnfocused" for="EmailSize">Maximum Email
                                    Size:</label>
                                <input id="EmailSize" name="EmailSize" type="text" type="number" is="emby-input"
                                    min="5" />
                                <div class="fieldDescription">
                                    Enter the maximum email size allowed by your email provider (in MB).
                                    For reliable delivery, set this value slightly below your provider's official limit
                                    (e.g., use 20 MB if your provider supports up to 25 MB).
                                    <b>Default: 15 MB</b>
                                </div>
                            </div>
                        </div>
                        <div class="fieldDescription">
                            Choose how newsletter posters should be included in the emails.<br>
                            <b>TMDB</b>: Uses image URLs from TheMovieDB (default, smallest emails).<br>
                            <b>Local Attachments</b>: Embeds images directly in the email (larger messages).
                        </div>
                    </div>

                    <!-- Email Tab -->
                    <div id="Email" class="tab-content">
                        <div class="config-header">
                            <h3>Email Configurations</h3>
                            <button type="button" is="emby-button" class="raised button-submit"
                                onclick="addEmailConfig()">
                                <span>+ Add Email Configuration</span>
                            </button>
                        </div>
                        <div id="EmailConfigList" class="config-list">
                            <p class="no-configs-text">No email configurations yet. Click "Add Email Configuration" to
                                create one.</p>
                        </div>
                    </div>

                    <!-- Discord Tab -->
                    <div id="Discord" class="tab-content">
                        <div class="config-header">
                            <h3>Discord Webhook Configurations</h3>
                            <button type="button" is="emby-button" class="raised button-submit"
                                onclick="addDiscordConfig()">
                                <span>+ Add Discord Webhook</span>
                            </button>
                        </div>
                        <div id="DiscordConfigList" class="config-list">
                            <p class="no-configs-text">No Discord configurations yet. Click "Add Discord Webhook" to
                                create one.</p>
                        </div>
                    </div>

                    <!-- Telegram Tab -->
                    <div id="Telegram" class="tab-content">
                        <div class="config-header">
                            <h3>Telegram Bot Configurations</h3>
                            <button type="button" is="emby-button" class="raised button-submit"
                                onclick="addTelegramConfig()">
                                <span>+ Add Telegram Bot</span>
                            </button>
                        </div>
                        <div id="TelegramConfigList" class="config-list">
                            <p class="no-configs-text">No Telegram configurations yet. Click "Add Telegram Bot" to
                                create one.</p>
                        </div>
                    </div>

                    <!-- buttons -->
                    <div style="margin-top: 20px;">
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <style>
            td {
                padding: 5px 10px;
            }

            .select-all-btn.all-selected {
                background-color: #4CAF50 !important;
                color: white !important;
            }

            .select-all-btn.all-selected span {
                color: white !important;
            }

            /* Inline styles for classes */
            .library-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
            }

            .library-table th {
                width: 50%;
                text-align: center;
                padding: 10px;
                border: 1px solid #444;
                background: rgba(255, 255, 255, 0.1);
            }

            .library-table td {
                vertical-align: top;
                padding: 10px;
                border: 1px solid #444;
            }

            .library-checkbox-container {
                max-height: 200px;
                overflow-y: auto;
            }

            .loading-text {
                text-align: center;
                opacity: 0.7;
            }

            .color-table {
                width: 100%;
                table-layout: fixed;
            }

            .color-table input {
                height: 2.2em;
                width: 100%;
            }

            /* Tab Styles */
            .tab-bar {
                display: flex;
                flex-wrap: wrap;
                border-bottom: 1px solid #444;
                margin-bottom: 20px;
            }

            .tab-link {
                background-color: transparent;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 10px 20px;
                font-size: 1.1em;
                color: #ccc;
                border-bottom: 2px solid transparent;
                transition: 0.3s;
            }

            .tab-link:hover {
                color: #fff;
                background-color: rgba(255, 255, 255, 0.05);
            }

            .tab-link.active {
                color: #fff;
                border-bottom: 2px solid #00a4dc;
            }

            .tab-content {
                display: none;
                padding: 10px 0;
                animation: fadeEffect 0.5s;
            }

            @keyframes fadeEffect {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            /* Multi-Configuration Styles */
            .config-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .config-header h3 {
                margin: 0;
            }

            .config-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .no-configs-text {
                text-align: center;
                opacity: 0.7;
                padding: 20px;
            }

            .config-accordion {
                border: 1px solid #444;
                border-radius: 4px;
                overflow: hidden;
            }

            .config-accordion-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                background: rgba(255, 255, 255, 0.05);
                cursor: pointer;
                user-select: none;
            }

            .config-accordion-header:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .config-accordion-title {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .config-accordion-title .expand-icon {
                transition: transform 0.3s;
            }

            .config-accordion.expanded .expand-icon {
                transform: rotate(90deg);
            }

            .config-accordion-actions {
                display: flex;
                gap: 8px;
            }

            .config-accordion-content {
                display: none;
                padding: 15px;
                border-top: 1px solid #444;
            }

            .config-accordion.expanded .config-accordion-content {
                display: block;
            }

            .config-action-btn {
                padding: 5px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.85em;
            }

            .config-action-btn.test-btn {
                background: #00a4dc;
                color: white;
            }

            .config-action-btn.delete-btn {
                background: #dc3545;
                color: white;
            }

            .config-action-btn:hover {
                opacity: 0.9;
            }

            .config-field-row {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
            }

            .config-field-row>.inputContainer {
                flex: 1;
                min-width: 200px;
            }
        </style>
        <script type="text/javascript">
            var NewsletterConfig = {
                pluginUniqueId: '60f478ab-2dd6-4ea0-af10-04d033f75979'
            };

            // In-memory config storage for multi-config management
            var discordConfigs = [];
            var telegramConfigs = [];
            var emailConfigs = [];

            // Tab switching function
            window.openTab = function (evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tab-link");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            };

            // Configuration fields mapping (for General tab only now)
            var FIELDS = {
                checkboxes: ['DebugMode', 'NewsletterOnItemAddedEnabled', 'NewsletterOnItemUpdatedEnabled', 'NewsletterOnItemDeletedEnabled', 'SeriesEnabled', 'MoviesEnabled'],
                inputs: ['Hostname', 'HostingSelector', 'EmailSize']
            };

            function updateMaxEmailSizeVisibility() {
                var posterType = document.querySelector('#HostingSelector').value;
                var maxEmailSizeDiv = document.getElementById('MaxEmailSizeContainer');
                if (maxEmailSizeDiv) {
                    maxEmailSizeDiv.style.display = (posterType === "attachment") ? '' : 'none';
                }
            }

            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0;
                    var v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // ===================== DISCORD CONFIG FUNCTIONS =====================

            function addDiscordConfig() {
                var newConfig = {
                    Id: generateUUID(),
                    Name: 'Discord Webhook',
                    WebhookURL: '',
                    WebhookName: 'Jellyfin Newsletter',
                    DescriptionEnabled: true,
                    ThumbnailEnabled: true,
                    RatingEnabled: true,
                    PGRatingEnabled: true,
                    DurationEnabled: true,
                    EpisodesEnabled: true,
                    SeriesAddEmbedColor: '#00FF00',
                    SeriesDeleteEmbedColor: '#FF0000',
                    SeriesUpdateEmbedColor: '#0000FF',
                    MoviesAddEmbedColor: '#00FF00',
                    MoviesDeleteEmbedColor: '#FF0000',
                    MoviesUpdateEmbedColor: '#0000FF'
                };
                discordConfigs.push(newConfig);
                renderDiscordConfigs();
            }

            function removeDiscordConfig(id) {
                if (confirm('Are you sure you want to remove this Discord webhook configuration?')) {
                    discordConfigs = discordConfigs.filter(function (c) { return c.Id !== id; });
                    renderDiscordConfigs();
                }
            }

            function testDiscordConfig(id) {
                Dashboard.showLoadingMsg();
                var url = ApiClient.getUrl('Discord/SendDiscordTestMessage') + '?configurationId=' + encodeURIComponent(id);
                ApiClient.ajax({ type: 'POST', url: url }).then(function () {
                    Dashboard.hideLoadingMsg();
                    alert("Test Discord message sent! Check your webhook channel.");
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    alert("Failed to send test message. Check server logs for details.");
                });
            }

            function toggleDiscordAccordion(id) {
                var accordion = document.getElementById('discord-accordion-' + id);
                if (accordion) {
                    accordion.classList.toggle('expanded');
                }
            }

            function updateDiscordConfigFromUI(id) {
                var config = discordConfigs.find(function (c) { return c.Id === id; });
                if (!config) return;

                config.Name = document.getElementById('discord-name-' + id).value || 'Unnamed';
                config.WebhookURL = document.getElementById('discord-url-' + id).value;
                config.WebhookName = document.getElementById('discord-webhookname-' + id).value;
                config.DescriptionEnabled = document.getElementById('discord-desc-' + id).checked;
                config.ThumbnailEnabled = document.getElementById('discord-thumb-' + id).checked;
                config.RatingEnabled = document.getElementById('discord-rating-' + id).checked;
                config.PGRatingEnabled = document.getElementById('discord-pgrating-' + id).checked;
                config.DurationEnabled = document.getElementById('discord-duration-' + id).checked;
                config.EpisodesEnabled = document.getElementById('discord-episodes-' + id).checked;
                config.SeriesAddEmbedColor = document.getElementById('discord-series-add-color-' + id).value;
                config.SeriesDeleteEmbedColor = document.getElementById('discord-series-delete-color-' + id).value;
                config.SeriesUpdateEmbedColor = document.getElementById('discord-series-update-color-' + id).value;
                config.MoviesAddEmbedColor = document.getElementById('discord-movies-add-color-' + id).value;
                config.MoviesDeleteEmbedColor = document.getElementById('discord-movies-delete-color-' + id).value;
                config.MoviesUpdateEmbedColor = document.getElementById('discord-movies-update-color-' + id).value;

                // Update header title
                var headerTitle = document.querySelector('#discord-accordion-' + id + ' .config-name');
                if (headerTitle) headerTitle.textContent = config.Name;
            }

            function renderDiscordConfigs() {
                var container = document.getElementById('DiscordConfigList');
                if (discordConfigs.length === 0) {
                    container.innerHTML = '<p class="no-configs-text">No Discord configurations yet. Click "Add Discord Webhook" to create one.</p>';
                    return;
                }

                var html = '';
                discordConfigs.forEach(function (config) {
                    html += '<div id="discord-accordion-' + config.Id + '" class="config-accordion">';
                    html += '  <div class="config-accordion-header" onclick="toggleDiscordAccordion(\'' + config.Id + '\')">';
                    html += '    <div class="config-accordion-title">';
                    html += '      <span class="expand-icon">▶</span>';
                    html += '      <span class="config-name">' + (config.Name || 'Unnamed') + '</span>';
                    html += '    </div>';
                    html += '    <div class="config-accordion-actions">';
                    html += '      <button type="button" class="config-action-btn test-btn" onclick="event.stopPropagation(); testDiscordConfig(\'' + config.Id + '\')">Test</button>';
                    html += '      <button type="button" class="config-action-btn delete-btn" onclick="event.stopPropagation(); removeDiscordConfig(\'' + config.Id + '\')">Delete</button>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '  <div class="config-accordion-content">';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Configuration Name:</label>';
                    html += '      <input id="discord-name-' + config.Id + '" type="text" is="emby-input" value="' + (config.Name || '') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')" />';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Webhook URL:</label>';
                    html += '      <input id="discord-url-' + config.Id + '" type="text" is="emby-input" value="' + (config.WebhookURL || '') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')" />';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Webhook Display Name:</label>';
                    html += '      <input id="discord-webhookname-' + config.Id + '" type="text" is="emby-input" value="' + (config.WebhookName || '') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')" />';
                    html += '    </div>';
                    html += '    <div style="margin: 15px 0;">';
                    html += '      <label class="inputLabel">Message Fields:</label>';
                    html += '      <table><tr>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="discord-desc-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.DescriptionEnabled ? 'checked' : '') + ' onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"><span>Description</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="discord-thumb-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.ThumbnailEnabled ? 'checked' : '') + ' onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"><span>Thumbnail</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="discord-rating-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.RatingEnabled ? 'checked' : '') + ' onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"><span>Rating</span></label></div></td>';
                    html += '      </tr><tr>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="discord-pgrating-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.PGRatingEnabled ? 'checked' : '') + ' onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"><span>PG Rating</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="discord-duration-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.DurationEnabled ? 'checked' : '') + ' onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"><span>Duration</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="discord-episodes-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.EpisodesEnabled ? 'checked' : '') + ' onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"><span>Episodes</span></label></div></td>';
                    html += '      </tr></table>';
                    html += '    </div>';
                    html += '    <div style="margin: 15px 0;">';
                    html += '      <label class="inputLabel">Embed Colors:</label>';
                    html += '      <table class="color-table">';
                    html += '        <tr><th>Series Add</th><th>Series Delete</th><th>Series Update</th></tr>';
                    html += '        <tr>';
                    html += '          <td><input id="discord-series-add-color-' + config.Id + '" type="color" value="' + (config.SeriesAddEmbedColor || '#00FF00') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"></td>';
                    html += '          <td><input id="discord-series-delete-color-' + config.Id + '" type="color" value="' + (config.SeriesDeleteEmbedColor || '#FF0000') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"></td>';
                    html += '          <td><input id="discord-series-update-color-' + config.Id + '" type="color" value="' + (config.SeriesUpdateEmbedColor || '#0000FF') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"></td>';
                    html += '        </tr>';
                    html += '        <tr><th>Movies Add</th><th>Movies Delete</th><th>Movies Update</th></tr>';
                    html += '        <tr>';
                    html += '          <td><input id="discord-movies-add-color-' + config.Id + '" type="color" value="' + (config.MoviesAddEmbedColor || '#00FF00') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"></td>';
                    html += '          <td><input id="discord-movies-delete-color-' + config.Id + '" type="color" value="' + (config.MoviesDeleteEmbedColor || '#FF0000') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"></td>';
                    html += '          <td><input id="discord-movies-update-color-' + config.Id + '" type="color" value="' + (config.MoviesUpdateEmbedColor || '#0000FF') + '" onchange="updateDiscordConfigFromUI(\'' + config.Id + '\')"></td>';
                    html += '        </tr>';
                    html += '      </table>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }

            // ===================== TELEGRAM CONFIG FUNCTIONS =====================

            function addTelegramConfig() {
                var newConfig = {
                    Id: generateUUID(),
                    Name: 'Telegram Bot',
                    BotToken: '',
                    ChatId: '',
                    DescriptionEnabled: true,
                    ThumbnailEnabled: true,
                    RatingEnabled: true,
                    PGRatingEnabled: true,
                    DurationEnabled: true,
                    EpisodesEnabled: true
                };
                telegramConfigs.push(newConfig);
                renderTelegramConfigs();
            }

            function removeTelegramConfig(id) {
                if (confirm('Are you sure you want to remove this Telegram bot configuration?')) {
                    telegramConfigs = telegramConfigs.filter(function (c) { return c.Id !== id; });
                    renderTelegramConfigs();
                }
            }

            function testTelegramConfig(id) {
                Dashboard.showLoadingMsg();
                var url = ApiClient.getUrl('Telegram/SendTelegramTestMessage') + '?configurationId=' + encodeURIComponent(id);
                ApiClient.ajax({ type: 'POST', url: url }).then(function () {
                    Dashboard.hideLoadingMsg();
                    alert("Test Telegram message sent! Check your chat.");
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    alert("Failed to send test message. Check server logs for details.");
                });
            }

            function toggleTelegramAccordion(id) {
                var accordion = document.getElementById('telegram-accordion-' + id);
                if (accordion) {
                    accordion.classList.toggle('expanded');
                }
            }

            function updateTelegramConfigFromUI(id) {
                var config = telegramConfigs.find(function (c) { return c.Id === id; });
                if (!config) return;

                config.Name = document.getElementById('telegram-name-' + id).value || 'Unnamed';
                config.BotToken = document.getElementById('telegram-token-' + id).value;
                config.ChatId = document.getElementById('telegram-chatid-' + id).value;
                config.DescriptionEnabled = document.getElementById('telegram-desc-' + id).checked;
                config.ThumbnailEnabled = document.getElementById('telegram-thumb-' + id).checked;
                config.RatingEnabled = document.getElementById('telegram-rating-' + id).checked;
                config.PGRatingEnabled = document.getElementById('telegram-pgrating-' + id).checked;
                config.DurationEnabled = document.getElementById('telegram-duration-' + id).checked;
                config.EpisodesEnabled = document.getElementById('telegram-episodes-' + id).checked;

                var headerTitle = document.querySelector('#telegram-accordion-' + id + ' .config-name');
                if (headerTitle) headerTitle.textContent = config.Name;
            }

            function renderTelegramConfigs() {
                var container = document.getElementById('TelegramConfigList');
                if (telegramConfigs.length === 0) {
                    container.innerHTML = '<p class="no-configs-text">No Telegram configurations yet. Click "Add Telegram Bot" to create one.</p>';
                    return;
                }

                var html = '';
                telegramConfigs.forEach(function (config) {
                    html += '<div id="telegram-accordion-' + config.Id + '" class="config-accordion">';
                    html += '  <div class="config-accordion-header" onclick="toggleTelegramAccordion(\'' + config.Id + '\')">';
                    html += '    <div class="config-accordion-title">';
                    html += '      <span class="expand-icon">▶</span>';
                    html += '      <span class="config-name">' + (config.Name || 'Unnamed') + '</span>';
                    html += '    </div>';
                    html += '    <div class="config-accordion-actions">';
                    html += '      <button type="button" class="config-action-btn test-btn" onclick="event.stopPropagation(); testTelegramConfig(\'' + config.Id + '\')">Test</button>';
                    html += '      <button type="button" class="config-action-btn delete-btn" onclick="event.stopPropagation(); removeTelegramConfig(\'' + config.Id + '\')">Delete</button>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '  <div class="config-accordion-content">';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Configuration Name:</label>';
                    html += '      <input id="telegram-name-' + config.Id + '" type="text" is="emby-input" value="' + (config.Name || '') + '" onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')" />';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Bot Token:</label>';
                    html += '      <input id="telegram-token-' + config.Id + '" type="text" is="emby-input" value="' + (config.BotToken || '') + '" onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      <div class="fieldDescription">Telegram bot token from @BotFather. Format: 123456789:ABCdefGhIJKlmnOPQRstuVWXyz123456789</div>';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Chat ID:</label>';
                    html += '      <input id="telegram-chatid-' + config.Id + '" type="text" is="emby-input" value="' + (config.ChatId || '') + '" onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      <div class="fieldDescription">Telegram chat ID or group ID to send messages to.</div>';
                    html += '    </div>';
                    html += '    <div style="margin: 15px 0;">';
                    html += '      <label class="inputLabel">Message Fields:</label>';
                    html += '      <table><tr>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="telegram-desc-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.DescriptionEnabled ? 'checked' : '') + ' onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')"><span>Description</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="telegram-thumb-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.ThumbnailEnabled ? 'checked' : '') + ' onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')"><span>Thumbnail</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="telegram-rating-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.RatingEnabled ? 'checked' : '') + ' onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')"><span>Rating</span></label></div></td>';
                    html += '      </tr><tr>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="telegram-pgrating-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.PGRatingEnabled ? 'checked' : '') + ' onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')"><span>PG Rating</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="telegram-duration-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.DurationEnabled ? 'checked' : '') + ' onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')"><span>Duration</span></label></div></td>';
                    html += '        <td><div class="checkboxContainer"><label class="emby-checkbox-label"><input id="telegram-episodes-' + config.Id + '" type="checkbox" is="emby-checkbox" ' + (config.EpisodesEnabled ? 'checked' : '') + ' onchange="updateTelegramConfigFromUI(\'' + config.Id + '\')"><span>Episodes</span></label></div></td>';
                    html += '      </tr></table>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }

            // ===================== EMAIL CONFIG FUNCTIONS =====================

            function addEmailConfig() {
                var newConfig = {
                    Id: generateUUID(),
                    Name: 'Email Configuration',
                    SMTPServer: 'smtp.gmail.com',
                    SMTPPort: 587,
                    SMTPUser: '',
                    SMTPPass: '',
                    VisibleToAddr: '',
                    ToAddr: '',
                    FromAddr: 'JellyfinNewsletter@donotreply.com',
                    Subject: 'Jellyfin Newsletter',
                    Body: '',
                    Entry: ''
                };
                emailConfigs.push(newConfig);
                renderEmailConfigs();
            }

            function removeEmailConfig(id) {
                if (confirm('Are you sure you want to remove this email configuration?')) {
                    emailConfigs = emailConfigs.filter(function (c) { return c.Id !== id; });
                    renderEmailConfigs();
                }
            }

            function testEmailConfig(id) {
                Dashboard.showLoadingMsg();
                var url = ApiClient.getUrl('SmtpMailer/SendTestMail') + '?configurationId=' + encodeURIComponent(id);
                ApiClient.ajax({ type: 'POST', url: url }).then(function () {
                    Dashboard.hideLoadingMsg();
                    alert("Test email sent! Check your inbox.");
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    alert("Failed to send test email. Check server logs for details.");
                });
            }

            function toggleEmailAccordion(id) {
                var accordion = document.getElementById('email-accordion-' + id);
                if (accordion) {
                    accordion.classList.toggle('expanded');
                }
            }

            function updateEmailConfigFromUI(id) {
                var config = emailConfigs.find(function (c) { return c.Id === id; });
                if (!config) return;

                config.Name = document.getElementById('email-name-' + id).value || 'Unnamed';
                config.SMTPServer = document.getElementById('email-server-' + id).value;
                config.SMTPPort = parseInt(document.getElementById('email-port-' + id).value) || 587;
                config.SMTPUser = document.getElementById('email-user-' + id).value;
                config.SMTPPass = document.getElementById('email-pass-' + id).value;
                config.VisibleToAddr = document.getElementById('email-to-' + id).value;
                config.ToAddr = document.getElementById('email-bcc-' + id).value;
                config.FromAddr = document.getElementById('email-from-' + id).value;
                config.Subject = document.getElementById('email-subject-' + id).value;
                config.Body = document.getElementById('email-body-' + id).value;
                config.Entry = document.getElementById('email-entry-' + id).value;

                var headerTitle = document.querySelector('#email-accordion-' + id + ' .config-name');
                if (headerTitle) headerTitle.textContent = config.Name;
            }

            function renderEmailConfigs() {
                var container = document.getElementById('EmailConfigList');
                if (emailConfigs.length === 0) {
                    container.innerHTML = '<p class="no-configs-text">No email configurations yet. Click "Add Email Configuration" to create one.</p>';
                    return;
                }

                var html = '';
                emailConfigs.forEach(function (config) {
                    html += '<div id="email-accordion-' + config.Id + '" class="config-accordion">';
                    html += '  <div class="config-accordion-header" onclick="toggleEmailAccordion(\'' + config.Id + '\')">';
                    html += '    <div class="config-accordion-title">';
                    html += '      <span class="expand-icon">▶</span>';
                    html += '      <span class="config-name">' + (config.Name || 'Unnamed') + '</span>';
                    html += '    </div>';
                    html += '    <div class="config-accordion-actions">';
                    html += '      <button type="button" class="config-action-btn test-btn" onclick="event.stopPropagation(); testEmailConfig(\'' + config.Id + '\')">Test</button>';
                    html += '      <button type="button" class="config-action-btn delete-btn" onclick="event.stopPropagation(); removeEmailConfig(\'' + config.Id + '\')">Delete</button>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '  <div class="config-accordion-content">';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Configuration Name:</label>';
                    html += '      <input id="email-name-' + config.Id + '" type="text" is="emby-input" value="' + (config.Name || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '    </div>';
                    html += '    <div class="config-field-row">';
                    html += '      <div class="inputContainer">';
                    html += '        <label class="inputLabel inputLabelUnfocused">SMTP Server:</label>';
                    html += '        <input id="email-server-' + config.Id + '" type="text" is="emby-input" value="' + (config.SMTPServer || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      </div>';
                    html += '      <div class="inputContainer">';
                    html += '        <label class="inputLabel inputLabelUnfocused">SMTP Port:</label>';
                    html += '        <input id="email-port-' + config.Id + '" type="number" is="emby-input" value="' + (config.SMTPPort || 587) + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      </div>';
                    html += '    </div>';
                    html += '    <div class="config-field-row">';
                    html += '      <div class="inputContainer">';
                    html += '        <label class="inputLabel inputLabelUnfocused">SMTP Username:</label>';
                    html += '        <input id="email-user-' + config.Id + '" type="text" is="emby-input" value="' + (config.SMTPUser || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      </div>';
                    html += '      <div class="inputContainer">';
                    html += '        <label class="inputLabel inputLabelUnfocused">SMTP Password:</label>';
                    html += '        <input id="email-pass-' + config.Id + '" type="password" is="emby-input" value="' + (config.SMTPPass || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      </div>';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">To Address:</label>';
                    html += '      <input id="email-to-' + config.Id + '" type="text" is="emby-input" value="' + (config.VisibleToAddr || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      <div class="fieldDescription">Recipient\'s email. Separate multiple with commas.</div>';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">BCC Address:</label>';
                    html += '      <input id="email-bcc-' + config.Id + '" type="text" is="emby-input" value="' + (config.ToAddr || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '      <div class="fieldDescription">BCC recipients. Separate multiple with commas.</div>';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">From Address:</label>';
                    html += '      <input id="email-from-' + config.Id + '" type="text" is="emby-input" value="' + (config.FromAddr || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Subject:</label>';
                    html += '      <input id="email-subject-' + config.Id + '" type="text" is="emby-input" value="' + (config.Subject || '') + '" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')" />';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Body HTML:</label>';
                    html += '      <textarea id="email-body-' + config.Id + '" style="width: 100%; height: 200px;" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')">' + (config.Body || '') + '</textarea>';
                    html += '    </div>';
                    html += '    <div class="inputContainer">';
                    html += '      <label class="inputLabel inputLabelUnfocused">Entry HTML:</label>';
                    html += '      <textarea id="email-entry-' + config.Id + '" style="width: 100%; height: 200px;" onchange="updateEmailConfigFromUI(\'' + config.Id + '\')">' + (config.Entry || '') + '</textarea>';
                    html += '    </div>';
                    html += '  </div>';
                    html += '</div>';
                });
                container.innerHTML = html;
            }

            // ===================== LIBRARY FUNCTIONS =====================

            function loadLibraries() {
                ApiClient.getJSON(ApiClient.getUrl('Library/MediaFolders')).then(function (result) {
                    renderLibrarySection(result.Items, 'tvshows', 'Series');
                    renderLibrarySection(result.Items, 'movies', 'Movies');
                }).catch(function (error) {
                    console.error('Error loading libraries:', error);
                    var seriesBox = document.getElementById('SeriesLibraryCheckboxes');
                    if (seriesBox) seriesBox.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Error loading series libraries. Check console for details.</p>';
                    var moviesBox = document.getElementById('MoviesLibraryCheckboxes');
                    if (moviesBox) moviesBox.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Error loading movies libraries. Check console for details.</p>';
                });
            }

            function renderLibrarySection(libraries, typeFilter, prefix) {
                var filtered = libraries.filter(function (l) {
                    return (l.CollectionType || '').toLowerCase() === typeFilter;
                });
                var container = document.getElementById(prefix + 'LibraryCheckboxes');

                if (!container) return;

                if (filtered.length === 0) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No ' + typeFilter + ' libraries found</p>';
                    return;
                }

                container.innerHTML = '';

                filtered.forEach(function (library) {
                    var div = document.createElement('div');
                    div.className = 'checkboxContainer checkboxContainer-withDescription';
                    div.style.marginBottom = '8px';

                    var label = document.createElement('label');
                    label.className = 'emby-checkbox-label';

                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = prefix + 'Library_' + library.Id;
                    checkbox.name = prefix + 'Library_' + library.Id;
                    checkbox.setAttribute('is', 'emby-checkbox');
                    checkbox.setAttribute('data-library-id', library.Id);
                    checkbox.className = prefix.toLowerCase() + '-library-checkbox';
                    // Event delegation handling via generic update
                    checkbox.onchange = function () { updateSelectionState(prefix); };

                    var span = document.createElement('span');
                    span.textContent = library.Name;

                    label.appendChild(checkbox);
                    label.appendChild(span);
                    div.appendChild(label);
                    container.appendChild(div);
                });

                // Load saved selections
                loadLibrarySelections(prefix);
            }

            // Load saved series/movies library selections
            function loadLibrarySelections(prefix) {
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    var savedIds = config['Selected' + prefix + 'Libraries'] || [];
                    var checkboxes = document.querySelectorAll('.' + prefix.toLowerCase() + '-library-checkbox');

                    // If no libraries are selected and enabled is true, select all by default
                    var enabledCb = document.querySelector('#' + prefix + 'Enabled');
                    var shouldSelectAll = savedIds.length === 0 && enabledCb && enabledCb.checked;

                    for (var i = 0; i < checkboxes.length; i++) {
                        var cb = checkboxes[i];
                        cb.checked = shouldSelectAll || savedIds.indexOf(cb.getAttribute('data-library-id')) !== -1;
                    }

                    // Update button state after loading selections
                    updateSelectionState(prefix);
                });
            }

            // Helper function to update button state based on current checkbox state and config
            function updateSelectionState(prefix) {
                var checkboxes = document.querySelectorAll('.' + prefix.toLowerCase() + '-library-checkbox');
                var allChecked = checkboxes.length > 0;
                for (var i = 0; i < checkboxes.length; i++) {
                    if (!checkboxes[i].checked) {
                        allChecked = false;
                        break;
                    }
                }

                // Function to update Enabled based on library selections
                var enabledCb = document.querySelector('#' + prefix + 'Enabled');
                if (enabledCb) enabledCb.checked = allChecked;

                // Helper function to update button state
                var btn = document.querySelector('#SelectAll' + prefix);
                if (btn) {
                    var span = btn.querySelector('span');
                    if (allChecked) {
                        btn.classList.add('all-selected');
                        if (span) span.textContent = 'Deselect All ' + prefix;
                    } else {
                        btn.classList.remove('all-selected');
                        if (span) span.textContent = 'Select All ' + prefix;
                    }
                }
            }

            // "Select All" button handler
            window.toggleAll = function (prefix) {
                var checkboxes = document.querySelectorAll('.' + prefix.toLowerCase() + '-library-checkbox');
                var allChecked = true;
                for (var i = 0; i < checkboxes.length; i++) {
                    if (!checkboxes[i].checked) {
                        allChecked = false;
                        break;
                    }
                }

                // Toggle all library checkboxes
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = !allChecked;
                }

                // Update Enabled and button state
                updateSelectionState(prefix);
            };

            // ===================== SAVE / LOAD CONFIG =====================

            function saveConfig() {
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    // General tab fields
                    FIELDS.checkboxes.forEach(function (id) {
                        var el = document.querySelector('#' + id);
                        if (el) config[id] = el.checked;
                    });
                    FIELDS.inputs.forEach(function (id) {
                        var el = document.querySelector('#' + id);
                        if (!el) return;
                        // Handle manual name mapping
                        if (id === 'HostingSelector') config.PosterType = el.value;
                        else config[id] = el.value;
                    });

                    // Formatting Settings
                    var decimalPlacesEl = document.querySelector('#CommunityRatingDecimalPlaces');
                    var decimalPlaces = decimalPlacesEl ? parseInt(decimalPlacesEl.value) : 1;
                    config.CommunityRatingDecimalPlaces = isNaN(decimalPlaces) ? 1 : decimalPlaces;

                    // Save selected libraries
                    var selectedSeriesLibraries = [];
                    var seriesChecked = document.querySelectorAll('.series-library-checkbox:checked');
                    for (var i = 0; i < seriesChecked.length; i++) {
                        selectedSeriesLibraries.push(seriesChecked[i].getAttribute('data-library-id'));
                    }
                    config.SelectedSeriesLibraries = selectedSeriesLibraries;

                    // Save selected movies libraries
                    var selectedMoviesLibraries = [];
                    var moviesChecked = document.querySelectorAll('.movies-library-checkbox:checked');
                    for (var i = 0; i < moviesChecked.length; i++) {
                        selectedMoviesLibraries.push(moviesChecked[i].getAttribute('data-library-id'));
                    }
                    config.SelectedMoviesLibraries = selectedMoviesLibraries;

                    // Save multi-configurations
                    config.DiscordConfigurations = discordConfigs;
                    config.TelegramConfigurations = telegramConfigs;
                    config.EmailConfigurations = emailConfigs;

                    ApiClient.updatePluginConfiguration(NewsletterConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        console.log("Config saved: ", result);
                    });
                });
            }

            function loadConfig() {
                ApiClient.getPluginConfiguration(NewsletterConfig.pluginUniqueId).then(function (config) {
                    console.log("Loading config...", config);

                    // General tab fields
                    FIELDS.checkboxes.forEach(function (id) {
                        var el = document.querySelector('#' + id);
                        if (el) el.checked = config[id];
                    });

                    FIELDS.inputs.forEach(function (id) {
                        var el = document.querySelector('#' + id);
                        if (el && config[id] !== undefined) el.value = config[id];
                    });

                    // Specific Mappings
                    var hostingEl = document.querySelector('#HostingSelector');
                    if (hostingEl && config.PosterType) hostingEl.value = config.PosterType;

                    var ratingEl = document.querySelector('#CommunityRatingDecimalPlaces');
                    if (ratingEl) ratingEl.value = config.CommunityRatingDecimalPlaces !== undefined ? config.CommunityRatingDecimalPlaces : 1;

                    updateMaxEmailSizeVisibility();

                    // Load multi-configurations
                    discordConfigs = config.DiscordConfigurations || [];
                    telegramConfigs = config.TelegramConfigurations || [];
                    emailConfigs = config.EmailConfigurations || [];

                    renderDiscordConfigs();
                    renderTelegramConfigs();
                    renderEmailConfigs();

                    loadLibraries();

                    Dashboard.hideLoadingMsg();
                });
            }

            document.querySelector('#NewsletterConfigPage')
                .addEventListener('pageshow', function () {
                    Dashboard.showLoadingMsg();
                    loadConfig();
                });

            document.querySelector('#NewsletterConfigForm')
                .addEventListener('submit', function (e) {
                    Dashboard.showLoadingMsg();
                    saveConfig();

                    e.preventDefault();
                    return false;
                });

            document.querySelector('#HostingSelector')
                .addEventListener('change', function () {
                    updateMaxEmailSizeVisibility();
                });
        </script>
    </div>
</body>

</html>